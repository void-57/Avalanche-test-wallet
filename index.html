<!DOCTYPE html>
<html>
  <head>
    <title>AVAX Wallet</title>
    <link rel="stylesheet" href="style.css" />
    <script src="lib.avax.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.9.2/src/sha3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5/dist/ethers.umd.min.js"></script>
    <script src="avaxCrypto.js"></script>
    <script src="avaxBlockchainAPI.js"></script>
  </head>
  <body>
    <h2>Generate or Recover Address</h2>
    <input id="inputKey" placeholder="Enter Private Key (optional)" size="60" />
    <button id="generateBtn">Generate / Recover</button>
    <pre id="output"></pre>

    <h2>Check Balance</h2>
    <input
      id="addressInput"
      placeholder="Enter AVAX Address (0x...)"
      size="60"
    />
    <button id="balanceBtn">Check Balance</button>
    <pre id="balanceOutput"></pre>

    <h2>Transaction History</h2>
    <input
      id="historyAddress"
      placeholder="Enter AVAX Address (0x...)"
      size="60"
    />
    <button id="historyBtn">Load History</button>
    <div id="paginationControls" style="margin: 10px 0; display: none">
      <button id="prevBtn" disabled>Previous</button>
      <span id="pageInfo">Page 1</span>
      <button id="nextBtn">Next</button>
      <span style="margin-left: 15px"
        >Showing <span id="currentCount">0</span> transactions</span
      >
    </div>
    <pre id="historyOutput"></pre>

    <h2>Send AVAX</h2>
    <input
      id="senderPrivateKey"
      placeholder="Your Private Key (FLO/BTC/AVAX)"
      size="60"
      type="password"
    />
    <input
      id="recipientAddress"
      placeholder="Recipient Address (0x...)"
      size="60"
    />
    <input id="sendAmount" placeholder="Amount (AVAX)" size="20" />
    <button id="sendBtn">Send Transaction</button>
    <div
      id="senderInfo"
      style="
        margin: 10px 0;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
        display: none;
      "
    >
      <strong>Sender Address:</strong> <span id="senderAddressDisplay"></span
      ><br />
      <strong>Balance:</strong> <span id="senderBalanceDisplay"></span> AVAX
    </div>
    <pre id="sendOutput"></pre>

    <script>
      function displayTransactionResult(isSuccess, data) {
        const sendOutput = document.getElementById("sendOutput");

        if (isSuccess) {
          sendOutput.innerHTML = `
            <div class="transaction-result">
              <div class="result-header success">
                <span class="status-icon">✅</span>
                <span>Transaction Successful!</span>
              </div>
              <div class="result-message">${data.message}</div>
              
              <div class="transaction-details">
                <div class="detail-row">
                  <span class="detail-label">From:</span>
                  <span class="detail-value address" title="${
                    data.from
                  }">${data.from.substring(0, 10)}...${data.from.substring(
            data.from.length - 8
          )}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">To:</span>
                  <span class="detail-value address" title="${
                    data.to
                  }">${data.to.substring(0, 10)}...${data.to.substring(
            data.to.length - 8
          )}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Amount:</span>
                  <span class="detail-value amount">${data.amount}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Transaction Hash:</span>
                  <span class="detail-value hash" title="${
                    data.transactionHash
                  }">${data.transactionHash.substring(
            0,
            12
          )}...${data.transactionHash.substring(
            data.transactionHash.length - 8
          )}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Block Number:</span>
                  <span class="detail-value">${data.blockNumber}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Gas Used:</span>
                  <span class="detail-value">${data.gasUsed}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Nonce:</span>
                  <span class="detail-value">${data.nonce}</span>
                </div>
              </div>
              
              <a href="${
                data.explorerLink
              }" target="_blank" class="explorer-link">
                View on SnowTrace Explorer
              </a>
            </div>
          `;
        } else {
          sendOutput.innerHTML = `
            <div class="transaction-result error">
              <div class="result-header error">
                <span class="status-icon">❌</span>
                <span>Transaction Failed</span>
              </div>
              
              <div class="error-details">
                <div class="error-message">${data.error}</div>
                <div style="color: #666; font-size: 12px;">
                  Time: ${new Date(data.timestamp).toLocaleString()}
                </div>
              </div>
              
              
            </div>
          `;
        }
      }

      // Pagination state
      let currentPage = 1;
      const transactionsPerPage = 10;
      let currentAddress = "";
      let hasMoreTransactions = false;

      // Generate or recover wallet
      document.getElementById("generateBtn").onclick = async () => {
        const input = document.getElementById("inputKey").value.trim();
        const result = await avaxCrypto.generateMultiChain(input);
        document.getElementById("output").textContent = JSON.stringify(
          result,
          null,
          2
        );
      };

      // Check balance for any address
      document.getElementById("balanceBtn").onclick = async () => {
        const address = document.getElementById("addressInput").value.trim();

        if (!address) {
          alert("Please enter an address!");
          return;
        }

        if (!address.startsWith("0x") || address.length !== 42) {
          alert(
            "Please enter a valid AVAX address (starts with 0x and 42 characters long)!"
          );
          return;
        }

        try {
          document.getElementById("balanceBtn").disabled = true;
          document.getElementById("balanceBtn").textContent = "Loading...";

          const balance = await getBalanceRPC(address);

          const result = balance.avax;

          document.getElementById("balanceOutput").textContent = JSON.stringify(
            result,
            null,
            2
          );
        } catch (error) {
          document.getElementById(
            "balanceOutput"
          ).textContent = `Error: ${error.message}`;
        } finally {
          document.getElementById("balanceBtn").disabled = false;
          document.getElementById("balanceBtn").textContent = "Check Balance";
        }
      };

      // Load transaction history for any address
      document.getElementById("historyBtn").onclick = async () => {
        const address = document.getElementById("historyAddress").value.trim();

        if (!address) {
          alert("Please enter an address!");
          return;
        }

        if (!address.startsWith("0x") || address.length !== 42) {
          alert("Please enter a valid AVAX address!");
          return;
        }

        try {
          document.getElementById("historyBtn").disabled = true;
          document.getElementById("historyBtn").textContent = "Loading...";

          // Reset to page 1 when loading new address
          currentAddress = address;
          currentPage = 1;

          // Fetch first page of transactions
          await loadTransactionPage();
        } catch (error) {
          document.getElementById(
            "historyOutput"
          ).textContent = `Error: ${error.message}`;
          document.getElementById("paginationControls").style.display = "none";
        } finally {
          document.getElementById("historyBtn").disabled = false;
          document.getElementById("historyBtn").textContent = "Load History";
        }
      };

      // Function to load a specific page of transactions
      async function loadTransactionPage() {
        try {
          // Fetch transactions for current page
          const result = await fetchAvalancheTxHistory(
            currentAddress,
            currentPage,
            transactionsPerPage
          );

          const transactions = result.transactions;
          hasMoreTransactions = result.hasMore;

          if (!transactions || transactions.length === 0) {
            document.getElementById("historyOutput").textContent =
              "No transactions found for this address.";
            document.getElementById("paginationControls").style.display =
              "none";
            return;
          }

          // Display transactions
          displayTransactions(transactions);

          // Show and update pagination controls
          document.getElementById("paginationControls").style.display = "block";
          updatePaginationControls(transactions.length);
        } catch (error) {
          document.getElementById(
            "historyOutput"
          ).textContent = `Error: ${error.message}`;
          document.getElementById("paginationControls").style.display = "none";
        }
      }

      function displayTransactions(transactions) {
        let html = `
          <div class="transaction-summary">
            <h3>Transaction History for ${currentAddress}</h3>
            <p>Page ${currentPage} - Showing ${transactions.length} transactions</p>
          </div>
          <table class="transaction-table">
            <thead>
              <tr>
                <th>From</th>
                <th>To</th>
                <th>Amount (AVAX)</th>
                <th>Transaction Hash</th>
                <th>Date & Time (IST)</th>
              </tr>
            </thead>
            <tbody>
        `;

        transactions.forEach((tx) => {
          // Format addresses
          const fromFormatted = tx.from
            ? `${tx.from.substring(0, 6)}...${tx.from.substring(
                tx.from.length - 4
              )}`
            : "N/A";
          const toFormatted = tx.to
            ? `${tx.to.substring(0, 6)}...${tx.to.substring(tx.to.length - 4)}`
            : "N/A";
          const hashFormatted = tx.hash
            ? `${tx.hash.substring(0, 10)}...${tx.hash.substring(
                tx.hash.length - 6
              )}`
            : "N/A";

          // Format date and time in IST
          let dateTimeIST = "N/A";
          if (tx.timeStamp) {
            const date = new Date(parseInt(tx.timeStamp) * 1000);
            // Convert to IST
            const istOptions = {
              timeZone: "Asia/Kolkata",
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
              hour12: false,
            };
            dateTimeIST = date.toLocaleString("en-IN", istOptions);
          }

          // Convert Wei to AVAX
          const value = tx.value ? parseFloat(tx.value) / 1e18 : 0;
          const amount = value > 0 ? value.toFixed(6) : "0.000000";

          html += `
            <tr>
              <td title="${tx.from}">${fromFormatted}</td>
              <td title="${tx.to}">${toFormatted}</td>
              <td>${amount}</td>
              <td title="${tx.hash}">
                <a href="https://snowtrace.io/tx/${tx.hash}" target="_blank">${hashFormatted}</a>
              </td>
              <td>${dateTimeIST}</td>
            </tr>
          `;
        });

        html += `
            </tbody>
          </table>
        `;

        document.getElementById("historyOutput").innerHTML = html;
      }

      // update pagination controls
      function updatePaginationControls(txCount) {
        document.getElementById("pageInfo").textContent = `Page ${currentPage}`;
        document.getElementById("currentCount").textContent = `${txCount}`;

        // Update button states
        document.getElementById("prevBtn").disabled = currentPage === 1;
        document.getElementById("nextBtn").disabled = !hasMoreTransactions;
      }

      // Previous button handler
      document.getElementById("prevBtn").onclick = async () => {
        if (currentPage > 1) {
          currentPage--;
          await loadTransactionPage();
        }
      };

      // Next button handler
      document.getElementById("nextBtn").onclick = async () => {
        if (hasMoreTransactions) {
          currentPage++;
          await loadTransactionPage();
        }
      };

      document.getElementById("senderPrivateKey").oninput = async () => {
        const privateKey = document
          .getElementById("senderPrivateKey")
          .value.trim();

        // Support FLO/BTC/AVAX private keys
        if (privateKey.length >= 51 && privateKey.length <= 66) {
          try {
            // Test if the private key can generate a wallet
            const wallet = await avaxCrypto.generateMultiChain(privateKey);

            // Check if we got a valid AVAX address
            if (wallet && wallet.AVAX && wallet.AVAX.address) {
              const senderAddress = wallet.AVAX.address;

              // Get balance
              const balance = await getBalanceRPC(senderAddress);

              // Show sender info
              document.getElementById("senderAddressDisplay").textContent =
                senderAddress;
              document.getElementById("senderBalanceDisplay").textContent =
                balance.avax;
              document.getElementById("senderInfo").style.display = "block";
            } else {
              document.getElementById("senderInfo").style.display = "none";
            }
          } catch (error) {
            document.getElementById("senderInfo").style.display = "none";
          }
        } else {
          document.getElementById("senderInfo").style.display = "none";
        }
      };

      // Send transaction
      document.getElementById("sendBtn").onclick = async () => {
        const privateKey = document
          .getElementById("senderPrivateKey")
          .value.trim();
        const recipient = document
          .getElementById("recipientAddress")
          .value.trim();
        const amount = document.getElementById("sendAmount").value.trim();

        // Basic validation
        if (!privateKey || !recipient || !amount) {
          alert(
            "Please fill in all fields: Private Key, Recipient Address, and Amount!"
          );
          return;
        }

        try {
          document.getElementById("sendBtn").disabled = true;
          document.getElementById("sendBtn").textContent = "Sending...";

          // Prepare transaction data
          const preparedTx = await prepareAvalancheTransaction(
            privateKey,
            recipient,
            amount
          );

          // Create ethers provider and wallet
          document.getElementById("sendBtn").textContent =
            "Signing & Sending...";
          const provider = new ethers.providers.JsonRpcProvider(
            preparedTx.rpcUrl
          );
          const ethersWallet = new ethers.Wallet(
            preparedTx.cleanPrivateKey,
            provider
          );

          // Prepare transaction for ethers
          const transaction = {
            to: preparedTx.recipientAddress,
            value: ethers.utils.parseEther(preparedTx.amount.toString()),
            gasLimit: preparedTx.gasLimit,
            gasPrice: preparedTx.gasPrice,
            nonce: preparedTx.nonce,
            chainId: preparedTx.chainId,
          };

          //  Sign and send the transaction
          const txResponse = await ethersWallet.sendTransaction(transaction);

          // Wait for confirmation
          const receipt = await txResponse.wait();

          const result = {
            status: "SUCCESS",
            transactionHash: txResponse.hash,
            blockNumber: receipt.blockNumber,
            gasUsed: receipt.gasUsed.toString(),
            from: preparedTx.senderAddress,
            to: preparedTx.recipientAddress,
            amount: preparedTx.amount + " AVAX",
            nonce: preparedTx.nonce,
            explorerLink: `https://snowtrace.io/tx/${txResponse.hash}`,
          };

          displayTransactionResult(true, {
            message: "Transaction sent successfully!",
            transactionHash: result.transactionHash,
            explorerLink: result.explorerLink,
            from: result.from,
            to: result.to,
            amount: result.amount,
            blockNumber: result.blockNumber,
            gasUsed: result.gasUsed,
            nonce: result.nonce,
          });
        } catch (error) {
          displayTransactionResult(false, {
            error: error.message,
            timestamp: new Date().toISOString(),
          });
        } finally {
          document.getElementById("sendBtn").disabled = false;
          document.getElementById("sendBtn").textContent = "Send Transaction";
        }
      };
    </script>
  </body>
</html>
